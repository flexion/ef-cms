service: ef-cms
plugins:
  - serverless-dynamodb-local
  - serverless-s3-local
  - serverless-plugin-split-stacks
  - serverless-domain-manager
  - serverless-plugin-bind-deployment-id
  - serverless-aws-documentation
  - serverless-plugin-aws-alerts
  - serverless-offline
  - serverless-plugin-warmup
  - serverless-prune-plugin
custom:

  prune:
    automatic: true
    number: 3

  serverless-offline:
    host: 0.0.0.0

  s3:
    host: 0.0.0.0
    port: 9000
    directory: ./storage/s3
    cors: cors-policy.xml

  warmup:
    enabled: 
      - dev
      - stg
      - prod

  dynamodb:
    start:
      inMemory: true
      migrate: true
      port: 8000
    seed:
      test:
        sources:
          - table: ${opt:efcmsTableName}
            sources:
              - ./storage/fixtures/efcms.json

  alerts:
    stages:
      - dev
      - stg
      - prod
    dashboards: true
    alarms:
      - functionThrottles
      - functionErrors
      - functionInvocations
      - functionDuration
  documentation:
    api:
      info:
        title: EF-CMS Documents API
        description: Documents API for U.S. Tax Court EF-CMS
        contact:
          url: https://www.ustaxcourt.gov
          email: webmaster@ustaxcourt.gov
        license:
          name: Creative Commons 0
          url: https://creativecommons.org/share-your-work/public-domain/cc0/
      tags:
        - name: ef-cms
          description: EF-CMS
        - name: documents
          description: rawDocument service
    summary: 'EF-CMS Documents API'
    version: '1'
    description: 'EF-CMS Documents API documented with OpenAPI specification'
    resources:
      - path: 'v1/documents'
        description: 'Path used for creating a rawDocument.'
      - path: 'v1/documents/{documentId}'
        description: 'Path used for retrieving rawDocument with a documentId.'
      - path: 'v1/documents/uploadPolicy'
        description: 'Path used for retrieving pre-signed policy url.'
      - path: 'v1/cases'
        description: 'Path used for creating a case.'
    models:
      - name: 'user'
        description: 'a user object'
        contentType: 'application/json'
        schema:
          type: object
          properties:
            userId:
              type: string
              description: the userId
      - name: 'case'
        description: 'a case response'
        contentType: 'application/json'
        schema:
          type: object
          properties:
            caseId:
              type: string
              description: id of case
            userId:
              type: string
              description: id of user who created the case
            createdAt:
              type: string
              description: date case created
            docketNumber:
              type: string
              description: the unique docket number associated with the case
            respondent:
              type: string
              description: the respondent who is associated with the case
            irsSendDate:
              type: string
              description: the date the case was sent to the IRS
            payGovId:
              type: string
              description: the pay gov id generated from pay.gov
            payGovDate:
              type: string
              description: the date the pay gov id was updated
            status:
              type: string
              description: the status of the case
            petitioners:
              type: array
              items:
                type: object
                properties:
                  userId:
                    type: string
            documents:
              type: array
              items:
                type: object
                properties:
                  documentId:
                    type: string
                  documentType:
                    type: string
                  workItems:
                    type: array
                    items:
                      type: object
              description: array of rawDocument ids and types associated with the case

      - name: 'document'
        description: 'a document response'
        contentType: 'application/json'
        schema:
          type: object
          properties:
            documentId:
              type: string
              description: id of rawDocument
            documentType:
              type: string
              description: type of this document
            userId:
              type: string
              description: id of user who created the document
            filedBy:
              type: boolean
              description: the user name who filed the document
            validated:
              type: boolean
              description: if the document has been validated
            reviewDate:
              type: string
              description: the date the user reviewed the document
            reviewUser:
              type: string
              description: the user who reviewed the document
            status:
              type: string
              description: the status of the document
            servedDate:
              type: string
              description: date document served
            createdAt:
              type: string
              description: date document created
      - name: 'workItem'
        description: 'a workItem response'
        contentType: 'application/json'
        schema:
          type: object
          properties:
            workItemId:
              type: string
              description: id of work item
            messages:
              type: array
              items:
                type: object
                properties:
                  messageId:
                    type: string
                  messageType:
                    type: string
              description: array of messages associated with the workitem
            sentBy:
              type: string
              description: the user or system function that generate or sent this original work item
            assigneeId:
              type: string
              description: id of user currently assigned the work item
            assigneeName:
              type: string
              description: the name of the user currently assigned the work item
            docketNumber:
              type: string
              description: date workItem created
            caseId:
              type: string
              description: the case id
            document:
              type: object
              properties:
                documentId:
                  type: string
                documentType:
                  type: string
                createAt:
                  type: string
            createdAt:
              type: string
              description: date workItem created
            updatedAt:
              type: string
              description: date workItem created
      - name: 'policyUrl'
        description: 'a policy url response'
        contentType: 'application/json'
        schema:
          type: object
          properties:
            url:
              type: string
              description: url
            fields:
              $ref: '{{model: fields}}'
      - name: 'fields'
        description: 'a policy url response'
        contentType: 'application/json'
        schema:
          type: object
          properties:
            bucket:
              type: string
              description: The bucket name.
            X-Amz-Algorithm:
              type: string
              description: The algorithm.
            X-Amz-Credential:
              type: string
              description: The credential.
            X-Amz-Date:
              type: string
              description: The date.
            X-Amz-Security-Token:
              type: string
              description: The security token.
            Policy:
              type: string
              description: The policy.
            X-Amz-Signature:
              type: string
              description: The signature.
      - name: 'awsError'
        description: 'an aws internal server error, usually with status code 502 (bad gateway)'
        contentType: 'application/json'
        schema:
          type: object
          properties:
            message:
              type: string
          required:
            - message
      - name: 'unprocessableEntityError'
        description: 'a unprocessable entity error (422), due to a problem in the body or the id in the url'
        contentType: 'application/json'
        schema:
          type: object
          properties:
            message:
              type: string
          required:
            - message

  customDomain:
    domainName: efcms-${self:provider.stage}.${opt:domain}
    basePath: ''
    endpointType: 'regional'
    certificateName: efcms-${self:provider.stage}.${opt:domain}
    certificateRegion: ${opt:region}
    stage: ${self:provider.stage}
    createRoute53Record: false
    enabled: true
  splitStacks:
    perFunction: true
    perType: false
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-1'}
  vars: ${file(./config/${self:custom.stage}.yml)}

provider:
  name: aws
  stage: ${self:custom.stage}
  region: ${self:custom.region}
  runtime: nodejs8.10
  memorySize: 128
  timeout: 10
  logRetentionInDays: 7
  s3Endpoint: s3.${opt:region}.amazonaws.com
  dynamodbEndpoint: dynamodb.${opt:region}.amazonaws.com
  masterRegion: us-east-1
  userPoolId: us-east-1_7uRkF0Axn
  masterDynamodbEndpoint: dynamodb.us-east-1.amazonaws.com
  deploymentBucket:
    name: ${env:SLS_DEPLOYMENT_BUCKET}
    serverSideEncryption: AES256

  environment:
    S3_ENDPOINT: ${self:custom.vars.s3Endpoint, self:provider.s3Endpoint}
    DOCUMENTS_BUCKET_NAME: ${opt:domain}-documents-${opt:stage}-${opt:region}
    DYNAMODB_ENDPOINT: ${self:custom.vars.dynamodbEndpoint, self:provider.dynamodbEndpoint}
    MASTER_DYNAMODB_ENDPOINT: ${self:custom.vars.masterDynamodbEndpoint, self:provider.masterDynamodbEndpoint}
    MASTER_REGION: ${self:custom.vars.masterRegion, self:provider.masterRegion}
    STAGE: ${self:custom.stage}
    USER_POOL_ID: ${opt:userPoolId, self:provider.userPoolId}

  iamRoleStatements:
    - Effect: 'Allow'
      Action:
        - 'lambda:InvokeFunction'
      Resource:
        - arn:aws:lambda:${opt:region}:${opt:accountId}:function:${self:service}-${opt:stage, self:provider.stage}-*
    - Effect: 'Allow'
      Action:
        - cognito-idp:AdminCreateUser
      Resource:
        - arn:aws:cognito-idp:${opt:region}:${opt:accountId}:userpool/${self:provider.environment.USER_POOL_ID}
    - Effect: 'Allow'
      Action:
        - 's3:*'
      Resource:
        Fn::Join:
          - ''
          - - 'arn:aws:s3:::'
            - ${self:provider.environment.DOCUMENTS_BUCKET_NAME}
            - '/*'
    - Effect: 'Allow'
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:BatchGetItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
        - dynamodb:BatchWriteItem
      Resource:
        - arn:aws:dynamodb:${opt:region}:${opt:accountId}:table/${opt:efcmsTableName}
        - arn:aws:dynamodb:${opt:region}:${opt:accountId}:table/${opt:efcmsTableName}/index/*

package:
  exclude:
    - ./storage
    - ./coverage
    - ./terraform
    - ./cognito

  excludeDevDependencies: true

resources:
  Resources:
    ApiGatewayAuthorizer: 
      Type: AWS::ApiGateway::Authorizer
      Properties: 
        Name: CognitoUserPool
        Type: COGNITO_USER_POOLS
        IdentitySource: method.request.header.Authorization
        RestApiId: 
          Ref: ApiGatewayRestApi
        ProviderARNs: 
          - arn:aws:cognito-idp:${opt:region}:${opt:accountId}:userpool/${self:provider.environment.USER_POOL_ID}

    #####
    # Begin Stage for API Gateway Logging
    #####
    ApiGatewayStage:
      Type: AWS::ApiGateway::Stage
      Properties:
        DeploymentId:
          Ref: __deployment__
        RestApiId:
          Ref: ApiGatewayRestApi
        StageName: ${opt:stage}
        MethodSettings:
          - DataTraceEnabled: true
            HttpMethod: '*'
            LoggingLevel: INFO
            ResourcePath: '/*'
            MetricsEnabled: true

functions:
  createDocument:
    handler: src/documents/createDocumentLambda.handler
    events:
      - http:
          path: v1/cases/{caseId}/documents
          method: post
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: create a new document inside of a case
            tags:
              - documents
            description: >
              Create a new document and attaches it to a case.  It will also create a generic work item.
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'the document metadata'
                responseModels:
                  'application/json': 'document'

  getUploadPolicy:
    handler: src/documents/getUploadPolicyLambda.handler
    events:
      - http:
          path: v1/documents/uploadPolicy
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: create a pre-signed url for uploads
            tags:
              - documents
            description: >
              Create a pre-signed url for  document uploads to S3.
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'pre-signed policy upload url'
                responseModels:
                  'application/json': 'policyUrl'

  getDocumentDownloadUrl:
    handler: src/documents/getDocumentDownloadUrl.handler
    events:
      - http:
          path: v1/documents/{documentId}/documentDownloadUrl
          method: get
          cors: true
          documentation:
            summary: redirects to the s3 url for downloading a document
            tags:
              - documents
            description: >
              Create and redirects the user to a pre-signed url for document downloads from S3.
            methodResponses:
              - statusCode: '302'
                responseBody:
                  description: 'a redirect to the s3 presigned download url'
                responseModels:
                  'application/json': 'policyUrl'

  getDownloadPolicyUrl:
    handler: src/documents/downloadPolicyUrlLambda.handler
    events:
      - http:
          path: v1/documents/{documentId}/downloadPolicyUrl
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: create a pre-signed url for downloads
            tags:
              - documents
            description: >
              Create a pre-signed url for  document downloads from S3.
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'pre-signed policy download url'
                responseModels:
                  'application/json': 'policyUrl'

  updateCase:
    handler: src/cases/updateCaseLambda.handler
    events:
      - http:
          path: v1/cases/{caseId}
          method: put
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: update a case
            tags:
              - cases
            description: >
              Update a case.
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'updated case'
                responseModels:
                  'application/json': case
              - statusCode: '422'
                responseModels:
                  'application/json': 'unprocessableEntityError'

  createCase:
    handler: src/cases/createCaseLambda.handler
    events:
      - http:
          path: v1/cases
          method: post
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: create a case
            tags:
              - cases
            description: >
              Create a case.
            parameters:
              - name: documents
                in: body
                required: true
                description:  document metadata
                schema:
                  type: array
                  items:
                    $ref: documents
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'case'
                responseModels:
                  'application/json': case

  getCasesByUser:
    handler: src/cases/getCasesByUserLambda.handler
    events:
      - http:
          path: v1/users/{userId}/cases
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: get all cases for a user
            tags:
              - cases
            description: >
              Get all cases for a user.
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'array of cases'
                responseModels:
                  'application/json': case

  getCasesForRespondent:
    handler: src/cases/getCasesForRespondentLambda.handler
    events:
      - http:
          path: v1/respondents/{respondentId}/cases
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: get all cases for a user
            tags:
              - cases
            description: >
              Get all cases for a user.
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'array of cases'
                responseModels:
                  'application/json': case


  getCasesByStatus:
    handler: src/cases/getCasesByStatusLambda.handler
    events:
      - http:
          path: v1/statuses/{status}/cases
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: get all cases by a status
            tags:
              - cases
            description: >
              get all cases by a status
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'array of cases'
                responseModels:
                  'application/json': case

  getCase:
    handler: src/cases/getCaseLambda.handler
    events:
      - http:
          path: v1/cases/{caseId}
          method: get
          request:
            parameters:
              paths:
                caseId: true
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: get a case by caseId
            tags:
              - cases
            description: >
              Get a case by caseId.
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'a case'
                responseModels:
                  'application/json': case

  sendToIRS:
    handler: src/cases/sendPetitionToIRSHoldingQueueLambda.handler
    events:
      - http:
          path: v1/cases/{caseId}/irsPetitionPackage
          method: post
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: sends the case to the holding queue
            tags:
              - cases
            description: >
              Send a packaged case to the respondent.
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'updated case including send date'
                responseModels:
                  'application/json': case
              - statusCode: '422'
                responseModels:
                  'application/json': 'unprocessableEntityError'

  recallFromIRS:
    handler: src/cases/recallPetitionFromIRSHoldingQueueLambda.handler
    events:
      - http:
          path: v1/cases/{caseId}/irsPetitionPackage
          method: delete
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: deletes the petition on the case from the holding queue
            tags:
              - cases
            description: >
              Deletes the petition on the case from the holding queue.
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'case status set to recalled and petition workitem updated'
                responseModels:
                  'application/json': case
              - statusCode: '422'
                responseModels:
                  'application/json': 'unprocessableEntityError'

  assignWorkItems:
    handler: src/workitems/assignWorkItemsLambda.handler
    events:
      - http:
          path: v1/workitems
          method: put
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: assigns an assigneId to a list of work item ids
            tags:
              - workitems
            description: >
              Get a workitem.
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'workitem'
                responseModels:
                  'application/json': workItem

  getWorkItem:
    handler: src/workitems/getWorkItemLambda.handler
    events:
      - http:
          path: v1/workitems/{workItemId}
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: get a workitem by workItemId
            tags:
              - workitems
            description: >
              Get a workitem.
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'workitem'
                responseModels:
                  'application/json': workItem

  forwardWorkItem:
    handler: src/workitems/forwardWorkItemLambda.handler
    events:
      - http:
          path: v1/workitems/{workItemId}/assignee
          method: put
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: sets the assigneeId of the workitem to a new user
            tags:
              - workitems
            description: >
              sets the assigneeId of the workitem to a new user.
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'workitem'
                responseModels:
                  'application/json': workItem

  updateWorkItem:
    handler: src/workitems/updateWorkItemLambda.handler
    events:
      - http:
          path: v1/workitems/{workItemId}
          method: put
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: update a workitem by workItemId
            tags:
              - workitems
            description: >
              Update a workitem.
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'workitem'
                responseModels:
                  'application/json': workItem

  getSentWorkItemsForSection:
    handler: src/workitems/getSentWorkItemsForSectionLambda.handler
    events:
      - http:
          path: v1/sections/{section}/outbox
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: get all workitems in the sections outbox
            tags:
              - workitems
            description: >
              Get all workitems in the sections outbox.
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'array of workitems'
                responseModels:
                  'application/json': workItem

  getWorkItemsBySection:
    handler: src/workitems/getWorkItemsBySectionLambda.handler
    events:
      - http:
          path: v1/sections/{section}/inbox
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: get all workitems in the sections inbox
            tags:
              - workitems
            description: >
              Get all workitems in the sections inbox.
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'array of workitems'
                responseModels:
                  'application/json': workItem

  getSentWorkItemsForUser:
    handler: src/workitems/getSentWorkItemsForUserLambda.handler
    events:
      - http:
          path: v1/users/{userId}/outbox
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: get a users work item outbox
            tags:
              - workitems
            description: >
              get a users work item outbox
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'array of workitems'
                responseModels:
                  'application/json': workItem

  getWorkItemsForUser:
    handler: src/workitems/getWorkItemsForUserLambda.handler
    events:
      - http:
          path: v1/users/{userId}/inbox
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: get a users work item inbox
            tags:
              - workitems
            description: >
              get a users work item inbox
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'array of workitems'
                responseModels:
                  'application/json': workItem

  getInternalUsers:
    handler: src/users/getInternalUsersLambda.handler
    events:
      - http:
          path: v1/users/internal
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: get all internal users
            tags:
              - workitems
            description: >
              get all internal users
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'array of users'
                responseModels:
                  'application/json': user

  getUsersInSection:
    handler: src/users/getUsersInSectionLambda.handler
    events:
      - http:
          path: v1/sections/{section}/users
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: get all users in a section
            tags:
              - workitems
            description: >
              get all users in a section
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'array of users in the section'
                responseModels:
                  'application/json': user

  createUser:
    handler: src/users/createUserLambda.handler
    events:
      - http:
          path: v1/users
          method: post
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
          documentation:
            summary: creates a user
            tags:
              - user
            description: >
              creates a user.
            methodResponses:
              - statusCode: '200'
                responseBody:
                  description: 'user created'
                responseModels:
                  'application/json': user
              - statusCode: '422'
                responseModels:
                  'application/json': 'unprocessableEntityError'

  swagger:
    handler: src/swagger/swaggerLambda.handler
    events:
      - http:
          path: v1/swagger
          method: get
          cors: true

  swaggerJson:
    handler: src/swagger/swaggerJsonLambda.handler
    events:
      - http:
          path: v1/swagger.json
          method: get
          cors: true